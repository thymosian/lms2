generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Organization {
  id                      String   @id @default(uuid())
  name                    String
  slug                    String   @unique
  dba                     String?
  ein                     String?
  staffCount              String?
  primaryContact          String?
  primaryEmail            String?
  phone                   String?
  address                 String?
  city                    String?
  country                 String?
  state                   String?
  zipCode                 String?
  licenseNumber           String?
  isHipaaCompliant        Boolean  @default(false)
  primaryBusinessType     String?
  additionalBusinessTypes String[] @default([])
  programServices         String[] @default([])
  joinCode                String?  @unique
  joinCodeExpiresAt       DateTime?
  users                   User[]
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  invites                 Invite[]
}

model Invite {
  id             String       @id @default(uuid())
  email          String
  token          String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("worker") // 'admin', 'supervisor', 'worker'
  status         String       @default("pending") // 'pending', 'accepted', 'expired'
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  invitedBy      String?      // User ID of the inviter

  @@index([email])
  @@index([token])
}

model User {
  id             String        @id @default(uuid())
  email          String        @unique
  password       String
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  role           String        @default("worker") // 'admin' | 'worker'
  emailVerified  Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  profile        Profile?
  courses        Course[] // Courses created by this user
  enrollments    Enrollment[]
  documents      Document[]
}

model Profile {
  id          String   @id // References User.id
  user        User     @relation(fields: [id], references: [id], onDelete: Cascade)
  email       String   @unique
  firstName   String?
  lastName    String?
  fullName    String?
  jobTitle    String? // E.g. 'Compliance Officer'
  companyName String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id           String            @id @default(uuid())
  userId       String
  user         User              @relation(fields: [userId], references: [id])
  filename     String
  originalName String
  mimeType     String
  size         Int
  versions     DocumentVersion[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model DocumentVersion {
  id             String            @id @default(uuid())
  documentId     String
  document       Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  version        Int               @default(1)
  storagePath    String
  hash           String // SHA-256 for immutability
  content        String?           @db.Text // Extracted text
  phiReport      PhiReport?
  courseVersions CourseVersion[]
  mapping        MappingEvidence[]
  createdAt      DateTime          @default(now())
}

model PhiReport {
  id                String          @id @default(uuid())
  documentVersionId String          @unique
  documentVersion   DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  hasPHI            Boolean         @default(false)
  detectedEntities  Json? // Store locations of detected PHI
  scannedAt         DateTime        @default(now())
}

model Course {
  id          String          @id @default(uuid())
  title       String
  description String?
  thumbnail   String?
  status      String          @default("draft") // 'draft' | 'published' | 'archived'
  category    String? // 'compliance' | 'safety' | 'hr' | 'custom'
  duration    Int? // estimated minutes
  createdBy   String
  creator     User            @relation(fields: [createdBy], references: [id])
  versions    CourseVersion[]
  lessons     Lesson[]
  enrollments Enrollment[]
  objectives  String[]        @default([])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model CourseVersion {
  id                String          @id @default(uuid())
  courseId          String
  course            Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  documentVersionId String
  documentVersion   DocumentVersion @relation(fields: [documentVersionId], references: [id])
  version           Int
  publishedAt       DateTime        @default(now())
}

model MappingEvidence {
  id                String          @id @default(uuid())
  documentVersionId String
  documentVersion   DocumentVersion @relation(fields: [documentVersionId], references: [id])
  standardId        String // e.g. "CARF_1.A.2"
  snippet           String          @db.Text
  justification     String?
  status            String          @default("pending") // 'pending' | 'approved' | 'rejected'
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model AuditorPack {
  id           String   @id @default(uuid())
  generatedBy  String
  scope        String // 'all' | 'specific_standards'
  downloadUrl  String?
  generatedAt  DateTime @default(now())
}

model Job {
  id        String   @id @default(uuid())
  userId    String?
  type      String // 'GENERATE_DRAFT' | 'EXPORT_PACK'
  status    String   @default("queued") // 'queued' | 'processing' | 'completed' | 'failed'
  payload   Json?
  result    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id        String   @id @default(uuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title     String
  content   String   @db.Text // HTML/Markdown content
  order     Int
  duration  Int? // minutes
  quiz      Quiz?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Quiz {
  id           String        @id @default(uuid())
  lessonId     String        @unique
  lesson       Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  title        String
  passingScore Int           @default(70)
  allowedAttempts Int?       @default(1) // null for unlimited
  timeLimit      Int?        // minutes
  difficulty     String?     // beginner, moderate, etc.
  questions    Question[]
  attempts     QuizAttempt[]
  createdAt    DateTime      @default(now())
}

model Question {
  id            String @id @default(uuid())
  quizId        String
  quiz          Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  text          String
  type          String // 'multiple_choice' | 'true_false' | 'short_answer'
  options       Json? // Array of options for multiple choice
  correctAnswer String
  order         Int
}

model Enrollment {
  id           String        @id @default(uuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  courseId     String
  course       Course        @relation(fields: [courseId], references: [id])
  status       String        @default("enrolled") // 'enrolled' | 'in_progress' | 'completed'
  progress     Int           @default(0) // percentage
  score        Int?
  startedAt            DateTime      @default(now())
  completedAt          DateTime?
  quizAttempts         QuizAttempt[]
  
  // Attestation Fields
  attestedAt           DateTime?
  attestationSignature String?
  attestationRole      String?

  @@unique([userId, courseId])
}

model QuizAttempt {
  id           String     @id @default(uuid())
  enrollmentId String
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  quizId       String
  quiz         Quiz       @relation(fields: [quizId], references: [id])
  answers      Json // Array of { questionId, selectedAnswer }
  score        Int
  timeTaken    Int? // seconds
  completedAt  DateTime   @default(now())

  @@unique([enrollmentId, quizId])
}

model VerificationToken {
  identifier String
  token      String
  type       String   @default("password_reset") // 'email_verification' | 'password_reset'
  expires    DateTime
  
  // For email_verification: store pending user data until verified
  password   String?  // hashed password
  firstName  String?
  lastName   String?
  role       String?  // 'admin' | 'worker'

  @@unique([identifier, token])
}



